import { AuthenticationProvider, Client } from '@microsoft/microsoft-graph-client'
import { User } from '@microsoft/microsoft-graph-types'

class CachedAuthProvider implements AuthenticationProvider {
  constructor (private readonly token: string) { this.token = token }
  public async getAccessToken (): Promise<string> { return this.token }
}

export const getUserInfo = async (token: string): Promise<any> => {
  const client = Client.initWithMiddleware({ authProvider: new CachedAuthProvider(token) })
  const meResponse = await client.api('/me').get() as User
  let imageUri: string = `data:image/png;base64,${defaultImage}`
  try {
    const photoResponse = await client.api('/me/photo/$value').get()
    const imageBuffer = await photoResponse.arrayBuffer()
    imageUri = `data:image/png;base64,${Buffer.from(imageBuffer).toString('base64')}`
  } catch (error) {
    console.error('Failed to get photo')
  }
  return {
    $root: {
      displayName: meResponse.displayName || '',
      mail: meResponse.mail || '',
      jobTitle: meResponse.jobTitle || '',
      givenName: meResponse.givenName || '',
      surname: meResponse.surname || '',
      imageUri
    }
  }
}

const defaultImage: string = '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'
